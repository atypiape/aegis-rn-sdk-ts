/**
 *  ================================================================
 * aegis-rn-sdk@1.39.1 (c) 2024 TencentCloud Real User Monitoring.
 * Author pumpkincai.
 * Last Release Time Thu Jan 18 2024 10:11:02 GMT+0800 (中国标准时间).
 * Released under the MIT License.
 * Thanks for supporting RUM & Aegis!
 * ================================================================
 **/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Aegis=t()}(this,function(){"use strict";var n=function(e,t){return(n=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}))(e,t)},u=function(){return(u=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function l(e,s,a,l){return new(a=a||Promise)(function(n,t){function i(e){try{r(l.next(e))}catch(e){t(e)}}function o(e){try{r(l.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?n(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(i,o)}r((l=l.apply(e,s||[])).next())})}function c(i,o){var r,s,a,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(r)throw new TypeError("Generator is already executing.");for(;l;)try{if(r=1,s&&(a=2&t[0]?s.return:t[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,t[1])).done)return a;switch(s=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,s=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!((a=0<(a=l.trys).length&&a[a.length-1])||6!==t[0]&&2!==t[0])){l=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3]))l.label=t[1];else if(6===t[0]&&l.label<a[1])l.label=a[1],a=t;else{if(!(a&&l.label<a[2])){a[2]&&l.ops.pop(),l.trys.pop();continue}l.label=a[2],l.ops.push(t)}}t=o.call(i,l)}catch(e){t=[6,e],s=0}finally{r=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}}function f(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var i=Array(e),o=0,t=0;t<n;t++)for(var r=arguments[t],s=0,a=r.length;s<a;s++,o++)i[o]=r[s];return i}Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(null==e)throw new TypeError("Cannot convert first argument to object");for(var t=Object(e),n=1;n<arguments.length;n++)if(null!=(i=arguments[n]))for(var i=Object(i),o=Object.keys(Object(i)),r=0,s=o.length;r<s;r++){var a=o[r],l=Object.getOwnPropertyDescriptor(i,a);null!=l&&l.enumerable&&(t[a]=i[a])}return t}});var N=["aegis.qq.com","tamaegis.com","/aegis-sdk","rumt-","/flog.core.min.js","pingfore.qq.com","pingfore.tencent.com","zhiyan.tencent-cloud.net","h.trace.qq.com","btrace.qq.com","beacon.qq.com","dmplog.qq.com","qq.com/report","svibeacon.onezapp.com","cube.weixinbridge.com","doubleclick.net","pcmgrmonitor.3g.qq.com","tdm.qq.com","report.qqweb.qq.com","tpstelemetry.tencent.com","insight.cloud.tencent.com","facebook.com","facebook.net","google","yahoo.com","twitter.com","ga-audiences","report.idqqimg.com","arms-retcode.aliyuncs.com","px.effirst.com","sentry","baidu.com","hot-update.json","u.c.b.r.o.w.s.e.r","report.url.cn","sockjs-node","m3u8"],k=global,p=["ext1","ext2","ext3","level","trace","tag","seq","code"],D=(e.prototype.indexOf=function(e,t){for(var n=0;n<e.length;n++)if(e[n].callback===t)return n;return-1},e.prototype.on=function(e,t,n){var i;if(void 0===n&&(n=0),this)return(i=this.eventsList[e])||(this.eventsList[e]=[],i=this.eventsList[e]),-1===this.indexOf(i,t)&&i.push({name:e,type:n||0,callback:t}),this},e.prototype.one=function(e,t){this.on(e,t,1)},e.prototype.remove=function(e,t){if(this){var n=this.eventsList[e];if(n){if(t)return n.length&&(t=this.indexOf(n,t),n.splice(t,1)),this;try{delete this.eventsList[e]}catch(e){}}return null}},e.prototype.clear=function(){this.eventsList={}},e);function e(){var s=this;this.emit=function(e,t){if(s){var n;if(null!=(i=s.eventsList[e])&&i.length)for(var i=i.slice(),o=0;o<i.length;o++){n=i[o];try{var r=n.callback.apply(s,[t]);if(1===n.type&&s.remove(e,n.callback),!1===r)break}catch(e){throw e}}return s}},this.eventsList={}}Array(32);var d,H=function(e){if(!e||0===e.length)return"{}";e=Array.isArray(e)?e:[e];var t=Object.keys(e[0]),n={},i=(t.forEach(function(t){n[t]=e.map(function(e){return e[t]})}),n.count=e.length,n);if("string"==typeof i)return i;try{return JSON.stringify(i,r())||"undefined"}catch(i){return"error happen when aegis stringify: \n "+i.message+" \n "+i.stack}};(_=d=d||{})[_.number=-1]="number",_.string="";function h(e,t){return"string"==typeof e?e.split("?")[t?1:0]||"":e}function g(e){return"string"==typeof e&&/^\//.test(e)?"https:"===(null===location||void 0===location?void 0:location.protocol):/^https/.test(e)}function m(t,e){return void 0===t&&(t=""),e=(e=void 0===e?"":e).split("?")[0],G.test(e)||F.some(function(e){return-1!==String(t).indexOf(e)})}function y(e,t,n){var i,o;try{if("function"==typeof(null==t?void 0:t.retCodeHandler))return{code:void 0===(r=(o=t.retCodeHandler(e,null==n?void 0:n.url,null==n?void 0:n.ctx,null==n?void 0:n.payload)||{}).code)?"unknown":r,isErr:o.isErr};if(!(e="string"==typeof e?JSON.parse(e):e))return{code:"unknown",isErr:!1};"function"==typeof(null==(i=null==t?void 0:t.ret)?void 0:i.join)&&(S=[].concat(t.ret.map(function(e){return e.toLowerCase()})));var r,s=Object.getOwnPropertyNames(e).filter(function(e){return-1!==S.indexOf(e.toLowerCase())});return s.length?{code:""+(r="未知"!==(r=e[s[0]])&&""!==r?r:"unknown"),isErr:0!==r&&"0"!==r&&"unknown"!==r}:{code:"unknown",isErr:!1}}catch(e){return{code:"unknown",isErr:!1}}}function v(r,s){void 0===s&&(s=3);var o,a,l,c="";return Array.isArray(r)?(c+="[",o=r.length,r.forEach(function(e,t){var n,i;c=(c+="object"==typeof e&&1<s?v(e,s-1):(i="",i+="undefined"==(n=typeof(e=e))||"symbol"==n||"function"==n?"null":"string"==n||"object"==n?'"'+e+'"':e))+(t===o-1?"":",")}),c+="]"):r instanceof Object?(c="{",a=Object.keys(r),l=a.length,a.forEach(function(e,t){var n,i,o;"object"==typeof r[e]&&1<s?c+='"'+e+'":'+v(r[e],s-1):c+=(n=r[e=e],o="","string"==(i=typeof n)||"object"==i?o+='"'+e+'":"'+n+'"':"function"==typeof n?o+='"'+e+'":"function '+n.name+'"':"symbol"==typeof n?o+='"'+e+'":"symbol"':"number"!=typeof n&&"boolean"!=i||(o+='"'+e+'": '+n),o),c+=t===l-1||t<l-1&&void 0===r[a[t+1]]?"":","}),c+="}"):c+=r,c}function b(t,e){return"string"!=typeof t||!t||e&&-1<t.indexOf(e)||J.test(t)||N.some(function(e){return-1<t.indexOf(e)})}function R(n,i){var o,r=[],s=n.config;return n.lifeCycle.on("destroy",function(){r.length=0}),function(e,t){Array.isArray(e)?r=r.concat(e):r.push(e),i&&r.length>=i||n.sendNow&&0<r.length?(r=B(r),t(r.splice(0,r.length)),o&&clearTimeout(o)):(o&&clearTimeout(o),o=setTimeout(function(){o=null,0<(r=B(r)).length&&t(r.splice(0,r.length))},s.delay))}}function M(e,t){return Array.isArray(e)?t(e.map(function(e){return t=u(u({},e),{msg:"string"==typeof e.msg?e.msg:[].concat(e.msg).map(T).join(" ")}),p.forEach(function(e){t[e]||delete t[e]}),t;var t})):t([u(u({},e),{msg:"string"==typeof e.msg?e.msg:T(e.msg)})])}function i(l,c){return function(e,t){var n,i,o,r=Array.isArray(e),s=r?e:[e],a=(l.lifeCycle.emit("beforeRequest",e),l.config.beforeRequest);(s="function"==typeof a?s.map(function(e){try{var t=a({logs:e,logType:c});return(null==t?void 0:t.logType)===c&&null!=t&&t.logs?t.logs:!1!==t&&e}catch(t){return e}}).filter(function(e){return!1!==e}):s).length&&(n=s,e=p,!Array.isArray(n)||n.length<=1||(i=[],o=[],!(o="string"==typeof e?[e]:e))||o.length<=0||(o.forEach(function(t){n.forEach(function(e){null!=e&&e[t]&&i.push(t)})}),0<i.length&&(n=n.map(function(e){var t={};return i.forEach(function(e){t[e]=""}),u(u({},t),e)}))),s=n,t(r?s:s[0]))}}function s(o){return function(e,t){o.lifeCycle.emit("modifyRequest",e);var n=o.config.modifyRequest;if("function"==typeof n)try{var i=n(e);"object"==typeof i&&"url"in i&&(e=i)}catch(e){console.error(e)}t(e)}}function a(i){return function(e,t){null!=(n=i.lifeCycle)&&n.emit("afterRequest",e);var n=(i.config||{}).afterRequest;"function"==typeof n&&!1===n(e)||t(e)}}function O(n){if(n&&n.reduce&&n.length)return 1===n.length?function(e,t){n[0](e,t||K)}:n.reduce(function(n,i){return function(e,t){return void 0===t&&(t=K),n(e,function(e){return null==i?void 0:i(e,t)})}});throw new TypeError("createPipeline need at least one function param")}function E(t,n){Object.getOwnPropertyNames(t).forEach(function(e){"function"==typeof t[e]&&"constructor"!==e&&(n?n[e]="sendPipeline"===e?function(){return function(){}}:function(){}:t[e]=function(){})})}var w,x,P,t,o,F=["application/xhtml+xml","application/xml","application/pdf","application/pkcs12","application/javascript","application/x-javascript","application/ecmascript","application/vnd.mspowerpoint","application/vnd.apple.mpegurl","application/ogg","text/css","text/javascript","image","audio","video","video/mp2t"],G=/\.(json|js|css|jpg|jpeg|png|svg|apng|webp|gif|bmp|mp4|mp3|ts|mpeg|wav|webm|ogg|flv|m3u8|ttf|woff2|otf|eot|woff|html|htm|shtml|shtm|)$/i,S=["ret","retcode","code","errcode"],r=function(){var n=new WeakSet;return function(e,t){if(t instanceof Error)return"Error.message: "+t.message+" \n  Error.stack: "+t.stack;if("object"==typeof t&&null!==t){if(n.has(t))return"[Circular "+(e||"root")+"]";n.add(t)}return t}},T=function(e){if("string"==typeof e)return e;try{return e instanceof Error?(JSON.stringify(e,r(),4)||"undefined").replace(/"/gim,""):JSON.stringify(e,r(),4)||"undefined"}catch(e){return"error happen when aegis stringify: \n "+e.message+" \n "+e.stack}},J=/data:(image|text|application|font)\/.*;base64/,B=((_=w=w||{}).INFO_ALL="-1",_.API_RESPONSE="1",_.INFO="2",_.ERROR="4",_.PROMISE_ERROR="8",_.AJAX_ERROR="16",_.SCRIPT_ERROR="32",_.IMAGE_ERROR="64",_.CSS_ERROR="128",_.CONSOLE_ERROR="256",_.MEDIA_ERROR="512",_.RET_ERROR="1024",_.REPORT="2048",_.PV="4096",_.EVENT="8192",_.PAGE_NOT_FOUND_ERROR="16384",_.WEBSOCKET_ERROR="32768",_.BRIDGE_ERROR="65536",_.LAZY_LOAD_ERROR="131072",(_=x=x||{}).LOG="log",_.SPEED="speed",_.PERFORMANCE="performance",_.OFFLINE="offline",_.WHITE_LIST="whiteList",_.VITALS="vitals",_.PV="pv",_.CUSTOM_PV="customPV",_.EVENT="event",_.CUSTOM="custom",_.SDK_ERROR="sdkError",_.SET_DATA="setData",_.LOAD_PACKAGE="loadPackage",(_=P=P||{}).production="production",_.development="development",_.gray="gray",_.pre="pre",_.daily="daily",_.local="local",_.test="test",_.others="others",function(e){return e.filter(function(n,i){return"static"!==n.type||!e.find(function(e,t){return n.url===e.url&&200===n.status&&i<t})})}),X=function(e){e.level===w.INFO_ALL&&(e.level=w.INFO)},L={},A={},C=function(e){return L[e]||(L[e]=setTimeout(function(){A[e]={},L[e]=null},6e4)),L[e]},V=function(e){return(Array.isArray(e)?e:[e]).map(function(n){return Object.getOwnPropertyNames(n).reduce(function(e,t){return"ctx"!==t&&(e[t]=n[t]),e},{level:w.INFO,msg:""})})},W=function(i){return function(e){return i.sendPipeline([function(e,n){return n({url:i.config.url||"",data:H(V(e)),method:"post",contentType:"application/json",type:x.LOG,log:e,requestConfig:{timeout:5e3},success:function(){var t=i.config.onReport;"function"==typeof t&&e.forEach(function(e){t(e)}),"function"==typeof n&&n([])}})}],x.LOG)(e)}},K=function(){},_=(I.use=function(e){-1===I.installedPlugins.indexOf(e)&&e.aegisPlugin&&I.installedPlugins.push(e)},I.unuse=function(e){e=I.installedPlugins.indexOf(e);-1!==e&&I.installedPlugins.splice(e,1)},I.prototype.init=function(e){this.setConfig(e);for(var t=0;t<I.installedPlugins.length;t++)try{I.installedPlugins[t].patch(this)}catch(e){this.sendSDKError(e)}this.lifeCycle.emit("onInited")},I.prototype.destroy=function(e){void 0===e&&(e=!1);var t,n,i=I.instances.indexOf(this);-1!==i&&I.instances.splice(i,1);for(var o=I.installedPlugins.length-1;0<=o;o--)try{I.installedPlugins[o].unpatch(this)}catch(e){this.sendSDKError(e)}if(this.lifeCycle.emit("destroy"),this.lifeCycle.clear(),e)t=this,n=Object.getOwnPropertyDescriptors(t),Object.keys(n).forEach(function(e){n[e].writable&&(t[e]=null)}),Object.setPrototypeOf(this,null);else{for(var r=this;r.constructor!==Object&&E(r,this),r=Object.getPrototypeOf(r););0===I.instances.length&&(i=Object.getPrototypeOf(this).constructor,E(i),E(I))}},I.prototype.setConfig=function(e){Object.assign(this.config,e);var e=this.config,t=e.id,n=e.uin,i=e.version,o=e.ext1,r=e.ext2,s=e.ext3,a=e.aid,l=e.env,c=void 0===l?"production":l,l=e.pageUrl,e=this.bean.id!==t||this.bean.uin!==n||this.bean.aid!==a;return this.bean.id=t||"",this.bean.uin=n||"",this.bean.version=i||"1.39.1",this.bean.aid=a||"",this.bean.env=function(){switch(c){case P.production:case P.development:case P.gray:case P.pre:case P.daily:case P.local:case P.test:case P.others:return 1;default:return}}()?c:P.others,l&&this.extendBean("from",encodeURIComponent(l.slice(0,2048))),o&&this.extendBean("ext1",encodeURIComponent(o)),r&&this.extendBean("ext2",encodeURIComponent(r)),s&&this.extendBean("ext3",encodeURIComponent(s)),e&&this.lifeCycle.emit("onConfigChange",this.config),this.config},I.prototype.extendBean=function(e,t){this.bean[e]=t},I.prototype.send=function(e,o,r){var t=this;return O([s(this),function(n,i){t.request(n,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];i({isErr:!1,result:e,logType:n.type,logs:n.log}),null!=o&&o.apply(void 0,e)},function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];i({isErr:!0,result:e,logType:n.type,logs:n.log}),null!=r&&r.apply(void 0,e)})},a(this)])(e)},I.prototype.sendSDKError=function(e){var n=this;this.sendPipeline([function(e,t){t({url:n.config.url+"?id=1085&msg[0]="+encodeURIComponent(T(e))+"&level[0]=2&from="+n.config.id+"&count=1&version="+n.config.id+"(1.39.1)",addBean:!1,method:"get",type:x.SDK_ERROR,log:e})}],x.SDK_ERROR)(e)},I.prototype.sendPipeline=function(e,t){var n,r=this;return O(f([function(e,t){if("number"!=typeof n.config.random&&(console.warn("random must in [0, 1], default is 1."),n.config.random=1),!n.isHidden||!n.isGetSample)if(n.isGetSample)n.isHidden||t(e);else{if(n.isGetSample=!0,Math.random()<n.config.random)return n.isHidden=!1,t(e);n.isHidden=!0}},i(n=this,t)],e,[s(this),function(i,o){r.request(i,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=!1;-1<(""+e[r.failRequestCount=0]).indexOf("403 forbidden")&&(n=!0,r.destroy()),o({isErr:n,result:e,logType:null==i?void 0:i.type,logs:null==i?void 0:i.log}),null!=(n=null==i?void 0:i.success)&&n.call.apply(n,f([i],e))},function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];60<=++r.failRequestCount&&r.destroy(),-1<(""+t[0]).indexOf("403 forbidden")&&r.destroy(),o({isErr:!0,result:t,logType:null==i?void 0:i.type,logs:null==i?void 0:i.log}),null!=(e=null==i?void 0:i.fail)&&e.call.apply(e,f([i],t))})},a(this)]))},I.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n={level:w.INFO,msg:e};1===e.length&&e[0].msg&&Object.assign(n,u({},e[0]),{level:w.INFO}),this.normalLogPipeline(n)},I.prototype.infoAll=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n={level:w.INFO_ALL,msg:e};1===e.length&&e[0].msg&&Object.assign(n,u({},e[0]),{level:w.INFO_ALL}),this.normalLogPipeline(n)},I.prototype.report=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n={level:w.REPORT,msg:e};1===e.length&&e[0].msg&&Object.assign(n,u({},e[0])),this.normalLogPipeline(n)},I.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n={level:w.ERROR,msg:e};1===e.length&&e[0].msg&&Object.assign(n,u({},e[0]),{level:w.ERROR}),this.normalLogPipeline(n)},I.prototype.reportEvent=function(e){e&&((e="string"==typeof e?{name:e,ext1:this.config.ext1||"",ext2:this.config.ext2||"",ext3:this.config.ext3||""}:e).name?("string"!=typeof e.name&&(console.warn("reportEvent params name must be string"),e.name=String(e.name)),this.eventPipeline(e)):console.warn("reportEvent params error"))},I.prototype.reportT=function(e){var t=e.name,n=e.duration,i=e.ext1,i=void 0===i?"":i,o=e.ext2,o=void 0===o?"":o,r=e.ext3,r=void 0===r?"":r,e=e.from;if("string"==typeof t&&"number"==typeof n&&"string"==typeof i&&"string"==typeof o&&"string"==typeof r){if(!(n<0||6e4<n))return this.submitCustomTime(t,n,i,o,r,void 0===e?"":e);console.warn("reportTime: duration must between 0 and 60000")}else console.warn("reportTime: params error")},I.prototype.reportTime=function(e,t){if("object"==typeof e)return this.reportT(e);"string"==typeof e?"number"==typeof t?t<0||6e4<t?console.warn("reportTime: duration must between 0 and 60000"):this.submitCustomTime(e,t):console.warn("reportTime: second param must be number"):console.warn("reportTime: first param must be a string")},I.prototype.time=function(e){"string"==typeof e?this.timeMap[e]?console.warn("Timer "+e+" already exists"):this.timeMap[e]=Date.now():console.warn("time: first param must be a string")},I.prototype.timeEnd=function(e){"string"==typeof e?this.timeMap[e]?(this.submitCustomTime(e,Date.now()-this.timeMap[e]),delete this.timeMap[e]):console.warn("Timer "+e+" does not exist"):console.warn("timeEnd: first param must be a string")},I.prototype.ready=function(e,t,n){throw new Error('You need to override "ready" method')},I.prototype.request=function(e,t,n){throw new Error('You need to override "request" method')},I.prototype.speedLogPipeline=function(e){throw new Error('You need to override "speedLogPipeline" method')},Object.defineProperty(I.prototype,"__version__",{get:function(){return"1.39.1"},enumerable:!1,configurable:!0}),Object.defineProperty(I.prototype,"LogType",{get:function(){return w},enumerable:!1,configurable:!0}),I.prototype.reportPv=function(e){e&&console.warn("reportPv is deprecated, please use reportEvent")},I.prototype.submitCustomTime=function(e,t,n,i,o,r){this.customTimePipeline({name:e,duration:t,ext1:n||this.config.ext1,ext2:i||this.config.ext2,ext3:o||this.config.ext3,from:r||void 0})},I.version="1.39.1",I.instances=[],I.logType=w,I.environment=P,I.installedPlugins=[],I),U=(q.prototype.patch=function(e){this.canUse(e)&&this.exist(e)&&(this.instances.push(e),this.triggerInit(e),this.triggerOnNewAegis(e))},q.prototype.unpatch=function(e){var t=this.instances.indexOf(e);-1!==t&&(this.instances.splice(t,1),0===this.instances.length)&&this.uninstall(e)},q.prototype.countInstance=function(){return this.instances.length},q.prototype.uninstall=function(e){var t;null!=(t=null==(t=this.option)?void 0:t.destroy)&&t.apply(this,[e])},q.prototype.walk=function(n){var i=this;this.instances.forEach(function(e){var t=i.canUse(e);t&&n(e,t)})},q.prototype.canUse=function(e){e=this.getConfig(e);return!(!e||"object"!=typeof e)||!!e},q.prototype.getConfig=function(e){return null==(e=e.config)?void 0:e[this.name]},q.prototype.exist=function(e){return-1===this.instances.indexOf(e)},q.prototype.triggerInit=function(e){var t;this.inited||(this.inited=!0,null==(t=null==(t=this.option)?void 0:t.init))||t.call(this.option,this.getConfig(e))},q.prototype.triggerOnNewAegis=function(e){var t;null!=(t=null==(t=this.option)?void 0:t.onNewAegis)&&t.call(this.option,e,this.getConfig(e))},q),$=fetch,_=(n(o=j,_=t=_),o.prototype=null===_?Object.create(_):(Z.prototype=_.prototype,new Z),Object.defineProperty(j.prototype,"getBean",{get:function(){var t=this;return Object.getOwnPropertyNames(this.bean).map(function(e){return e+"="+t.bean[e]}).join("&")},enumerable:!1,configurable:!0}),j.prototype.reportError=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.normalLogPipeline({msg:e,level:w.ERROR})},j.prototype.uploadLogs=function(e,t){this.lifeCycle.emit("uploadLogs",e=void 0===e?{}:e,t=void 0===t?{}:t)},j.prototype.getAsyncStorage=function(){return require("@react-native-async-storage/async-storage")},j.prototype.getCurrentPageUrl=function(){var e=this.config.pageUrl||location.href||"-",e=(e="function"==typeof this.config.urlHandler?this.config.urlHandler():e).slice(0,2048);return encodeURIComponent(e)},j.sessionID="session-"+Date.now(),j.asyncPluginIndex=0,j),Y=new U({name:"aid",init:function(){},onNewAegis:function(t){this.getAid(t).then(function(e){t.bean.aid=e,t.config.aid=e})},getAid:function(o){return l(this,void 0,void 0,function(){var t,n,i;return c(this,function(e){switch(e.label){case 0:t="AEGIS_ID",n=o.getAsyncStorage(),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,n.getItem(t)];case 2:return(i=e.sent())||(i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),n.setItem(t,i)),[2,i||""];case 3:return e.sent(),[2,""];case 4:return[2]}})})}}),z=new U({name:"onError",listening:!1,init:function(){this.startListen()},startListen:function(){var o,t,n,e,i,r,s,a=this;this.listening||(this.listening=!0,o=k.ErrorUtils,t=o.setGlobalHandler,o.setGlobalHandler=function(n,e){var i;"willCallOriginHandler"===e?t.call(o,n):(i=o.getGlobalHandler,t(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];i.call.apply(i,f([o],e)),n.call.apply(n,f([o],e))}))},n=o.getGlobalHandler(),o.setGlobalHandler(function(e,t){e&&a.publishErrorLog({msg:e+"\n"+e.stack,level:w.ERROR}),"function"==typeof n&&n.call(o,e,t)},"willCallOriginHandler"),require("promise/setimmediate/rejection-tracking").enable({allRejections:!0,onUnhandled:function(e,t,n){var i=w.PROMISE_ERROR,o="object"==typeof t?JSON.stringify(t):t;if("object"==typeof t&&"error"in t&&"retcode"in t.error){if(t.error.networkError)return;i=w.RET_ERROR}a.publishErrorLog({msg:"PROMISE_ERROR: "+o+"\n"+n,level:i})}}),e=window.XMLHttpRequest.prototype,i=e.open,r=e.send,s=this,"aegisFakeXhrOpen"!==i.name&&(e.open=function(){return this.aegisMethod&&this.aegisUrl||(this.aegisMethod=arguments[0],this.aegisUrl=arguments[1],this.aegisXhrStartTime=Date.now()),i.apply(this,arguments)}),"aegisFakeXhrSend"!==r.name&&(e.send=function(){var t=this;return t.sendByAegis||t.addEventListener("loadend",function(){var e="";t.failType?e=t.failType:t.status?400<=t.status&&(e="error"):e="failed",e&&s.publishErrorLog({msg:"AJAX_ERROR: request "+e+"\n                    \nreq url: "+t.aegisUrl+"\n                    \nres status: "+(t.status||0)+"\n                    \nres duration: "+(Date.now()-t.aegisXhrStartTime)+"ms\n                    \nreq method: "+t.aegisMethod,level:w.AJAX_ERROR})}),this.sendByAegis||this.addEventListener("timeout",function(){this.failType="timeout"}),r.apply(this,arguments)}))},publishErrorLog:function(t){this.$walk(function(e){e.normalLogPipeline(t)})}}),Q=new U({name:"reportApiSpeed",override:!1,onNewAegis:function(e){this.override||(this.override=!0,this.overrideFetch(e.config),this.overrideXhr(e.config))},overrideFetch:function(a){var e,l;"function"==typeof window.fetch&&"aegisFakeFetch"!==window.fetch.name&&(e=window.fetch,l=this,window.fetch=function(o,r){var s=Date.now();return e(o,r).then(function(i){if(!b(o,a.hostUrl))try{var e,t=i.headers&&i.headers.get("content-type")||"";i.ok&&m(t,o)?(e={url:h(i.url),isHttps:g(i.url),method:(null==r?void 0:r.method)||"get",duration:Date.now()-s,type:"static",status:i.status,nextHopProtocol:"",urlQuery:h(i.url,!0),domainLookup:d.number,connectTime:d.number},l.publishSpeed(e)):i.clone().text().then(function(e){l.publishNormalLog({msg:o+" "+e,level:w.API_RESPONSE});var t=y(e,a.api,{url:o,ctx:i,payload:null==r?void 0:r.body})||{},n=t.code,t=t.isErr,n={url:h(i.url),isHttps:g(i.url),method:(null==r?void 0:r.method)||"get",duration:Date.now()-s,type:"fetch",nextHopProtocol:"",ret:n||"unknown",isErr:+t,status:i.status,payload:null==r?void 0:r.body};l.publishSpeed(n),t&&l.publishNormalLog({msg:"request url: "+o+" \n response: "+e,level:w.RET_ERROR})})}catch(e){}return i}).catch(function(e){var t,n;throw b(o,a.hostUrl)||(n=Date.now()-s,t={url:h(o),isHttps:g(o),method:(null==r?void 0:r.method)||"get",duration:n,nextHopProtocol:"",type:"fetch",status:0},l.publishSpeed(t),t=null!=(t=a.api)&&t.apiDetail?function(e,t,n){try{var i="function"==typeof t?t(e,null==n?void 0:n.url)||"":e;return v(i).slice(0,102400)}catch(e){return""}}(null==r?void 0:r.body,null==(t=a.api)?void 0:t.reqParamHandler,{url:o}):"",n="AJAX_ERROR: "+e+"\n                          \nreq url: "+o+"\n                          \nres status: 0\n                          \nres duration: "+n+"ms\n                          \nreq method: "+((null==r?void 0:r.method)||"get")+"\n                          \nreq param: "+t,l.publishNormalLog({msg:n,level:w.AJAX_ERROR})),e})})},overrideXhr:function(c){var e=window.XMLHttpRequest.prototype,t=e.open,n=e.send,u=this;"aegisFakeXhrOpen"!==t.name&&(e.open=function(){return this.aegisMethod&&this.aegisUrl||(this.aegisMethod=arguments[0],this.aegisUrl=arguments[1],this.aegisXhrStartTime=Date.now()),t.apply(this,arguments)}),"aegisFakeXhrSend"!==n.name&&(e.send=function(){var s,a=Date.now(),l=this;return l.sendByAegis||l.addEventListener("loadend",function(){var e=l.aegisUrl;if(e&&!b(e,c.hostUrl)){s=Date.now()-a;var t={url:h(e),isHttps:g(e),status:l.status||0,method:l.aegisMethod||"get",type:"fetch",duration:s,nextHopProtocol:""},n=l.getResponseHeader("content-type")||"";if(400<=l.status||!m(n,t.url))try{u.publishNormalLog({msg:"req url: "+e+"\n                        \nres status: "+l.status+"\n                        \nres duration: "+s+"ms\n                        \nres method: "+t.method+"\n                        \nres data: "+JSON.stringify(l.response),level:w.API_RESPONSE});var i=y(l.response,c.api,{url:e,ctx:l})||{},o=i.code,r=i.isErr;t.ret=o,t.isErr=+r,r&&u.publishNormalLog({msg:"request url: "+e+" \n response: "+l.response,level:w.RET_ERROR})}catch(e){t.ret="unknown"}else delete t.ret,Object.assign(t,{urlQuery:h(e,!0),type:"static",domainLookup:d.number,connectTime:d.number});u.publishSpeed(t)}}),n.apply(this,arguments)})},publishSpeed:function(t){this.$walk(function(e){e.speedLogPipeline(t)})},publishNormalLog:function(t){this.$walk(function(e){e.normalLogPipeline(t)})}}),U=new U({name:"device",onNewAegis:function(){}});function j(e){var s,a=t.call(this,e)||this;a.originRequest=$,a.speedLogPipeline=O([(s=a.config,function(e,t){var n,i,o,r="number"==typeof s.repeat?s.repeat:60;!s.speedSample||r<=0?t(e):(n=(null==s?void 0:s.id)||"0",i=A[n]||{},Array.isArray(e)?(o=e.filter(function(e){var t=!i[e.url]||i[e.url]<r;return t?(i[e.url]=1+~~i[e.url],A[n]=i):L[n]||C(n),t})).length&&t(o):!i[e.url]||i[e.url]<r?(i[e.url]=1+~~i[e.url],A[n]=i,t(e)):L[n]||C(n))}),R(a),function(e,t){a.lifeCycle.emit("beforeReportSpeed",e);var n=a.config.beforeReportSpeed;if((e="function"==typeof n?e.filter(function(e){return!1!==n(e)}):e).length)return t(e)},i(a,x.SPEED),function(e,t){t(e.map(function(e){return void 0!==e.payload&&delete e.payload,e}))},function(e){var t,n,i,o;a.send({url:""+a.config.speedUrl,method:"post",data:(e=e,t=a.bean,i={fetch:[],static:[],bridge:[]},o={},Array.isArray(e)?e.forEach(function(e){var t;null!=(t=i[e.type])&&t.push(e)}):null!=(n=i[e.type])&&n.push(e),o.payload=JSON.stringify(u({duration:i},t)),o),contentType:"application/json"})}]),a.request=function(e,i,o){var t,n,r,s;e&&"string"==typeof e.url&&""!==e.url&&a.bean.id&&(t=e.url,!1!==e.addBean&&(t=t+(-1===t.indexOf("?")?"?":"&")+a.getBean),("get"===(e.method||"get").toLocaleLowerCase()?a.originRequest((n=t,r=e.data,"string"!=typeof n?"":"object"==typeof r&&r?(s=Object.getOwnPropertyNames(r).map(function(e){var t=r[e];return e+"="+("string"==typeof t?encodeURIComponent(t):encodeURIComponent(JSON.stringify(t)))}).join("&").replace(/eval/gi,"evaI"),n+(-1===n.indexOf("?")?"?":"&")+s):n),u({},e.requestConfig)):("string"==typeof e.data?e.data=e.data.replace(/eval/gi,"evaI"):e.data=JSON.stringify(e.data),a.originRequest(t,u({method:"POST",body:e.data,headers:e.contentType?{"Content-Type":e.contentType}:void 0},e.requestConfig)))).then(function(n){return l(a,void 0,void 0,function(){var t;return c(this,function(e){switch(e.label){case 0:if(!(n.status<400&&0<n.status))return[3,5];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,n.json()];case 2:return t=e.sent(),null!=i&&i(JSON.stringify(t)||""),[3,4];case 3:return e.sent(),null!=i&&i(""),[3,4];case 4:return[3,6];case 5:null!=o&&o(n),e.label=6;case 6:return[2]}})})}).catch(function(e){null!=o&&o(e)}))};try{a.init(e),a.extendBean("from",a.getCurrentPageUrl()),a.extendBean("sessionId",j.sessionID)}catch(e){console.warn(e),console.log("%cThe above error occurred in the process of initializing Aegis, which will affect your normal use of Aegis.\nIt is recommended that you contact us for feedback and thank you for your support.","color: red"),a.sendSDKError(e)}return a}function Z(){this.constructor=o}function q(e){this.aegisPlugin=!0,this.name="",this.instances=[],this.inited=!1,e.$walk=this.walk.bind(this),e.$getConfig=this.getConfig.bind(this),this.option=e,this.name=e.name}function I(e){var n,t,i,o,s,r,a,l,c,u,f,p,d,h,g=this;this.isGetSample=!1,this.isHidden=!1,this.config={version:0,delay:1e3,onError:!0,repeat:60,random:1,aid:!0,device:!0,pagePerformance:!0,webVitals:!0,speedSample:!0,onClose:!0,reportLoadPackageSpeed:!0,hostUrl:"https://aegis.qq.com",env:"production",url:"",offlineUrl:"",whiteListUrl:"",pvUrl:"",speedUrl:"",customTimeUrl:"",performanceUrl:"",performanceUrlForHippy:"",webVitalsUrl:"",eventUrl:"",setDataReportUrl:"",reportImmediately:!0},this.isWhiteList=!1,this.lifeCycle=new D,this.bean={},this.normalLogPipeline=O([R(this,5),M,function(e,t){var i=n.config;t(e=e.map(function(e){var t,n=i.maxLength||102400;try{if(!e.msg||e.msg.length<=n)return e;e.msg=null==(t=e.msg)?void 0:t.substring(0,n)}catch(t){e.msg=T(e.msg).substring(0,i.maxLength)}return e}))},(h=(n=this).config,function(e,t){var n="number"==typeof h.repeat?h.repeat:60;if(n<=0)return t(e);var i=(null==h?void 0:h.id)+"_error",o=A[i]||{};t(e.filter(function(e){if(e.level===w.ERROR||e.level===w.PROMISE_ERROR||e.level===w.AJAX_ERROR||e.level===w.SCRIPT_ERROR||e.level===w.IMAGE_ERROR||e.level===w.CSS_ERROR||e.level===w.MEDIA_ERROR||e.level===w.RET_ERROR||e.level===w.BRIDGE_ERROR||e.level===w.PAGE_NOT_FOUND_ERROR||e.level===w.WEBSOCKET_ERROR||e.level===w.LAZY_LOAD_ERROR){e=e.msg.slice(0,200);if(o[e]>n)return L[i]||C(i),!1;o[e]=1+~~o[e],A[i]=o}return!0}))}),(p=this.lifeCycle.emit,d=this.config,function(e,t){var n,i=d.logCreated;return"function"==typeof i?(n=e.filter(function(e){return!1!==i(e)}),p("beforeWrite",n),t(n)):(p("beforeWrite",e),t(e))}),(f=this,setTimeout(function(){var e=f.config,t=e.pvUrl,n=void 0===t?"":t,t=e.spa,e=-1<["web-sdk","mp-sdk"].indexOf("rn-sdk");n&&(e&&!t||!e)&&f.sendPipeline([function(e,t){t({url:n,type:x.PV})}],x.PV)(null)},100),function(e,t){t(e)}),(c=l=a=!1,u=[],(s=this).lifeCycle.on("onConfigChange",function(){r&&clearTimeout(r),r=setTimeout(function(){var e,n;!c&&s.config&&(c=!0,e=s.config.whiteListUrl,(n=void 0===e?"":e)&&s.sendPipeline([function(e,t){t({url:n,type:x.WHITE_LIST,success:function(e){l=!0;try{var t=e.data||JSON.parse(e),n=t.retcode,i=t.result,o=void 0===i?{}:i,r=(0===n&&(a=o.is_in_white_list,s.isWhiteList=a,0<=o.rate)&&o.rate<=1&&(s.config.random=o.rate,s.isGetSample=!1),s.isWhiteList&&u.length?W(s)(u.splice(0),function(){}):!s.isWhiteList&&u.length&&(u.length=0),s.config.onWhitelist);"function"==typeof r&&r(a)}catch(e){}},fail:function(){l=!0}})}],x.WHITE_LIST)(null),c=!1)},s.config.uin?50:500)}),s.lifeCycle.on("destroy",function(){u.length=0}),function(e,t){var n;a||null!=(n=null==(n=s.config)?void 0:n.api)&&n.reportRequest?t(e.concat(u.splice(0)).map(function(e){return X(e),e})):(n=e.filter(function(e){return e.level!==w.INFO&&e.level!==w.API_RESPONSE?(X(e),!0):(l||(u.push(e),200<=u.length&&(u.length=200)),!1)})).length&&t(n)}),function(e,t){try{var n=JSON.parse(JSON.stringify(e)),i=(g.lifeCycle.emit("beforeReport",n),g.config.beforeReport);(e="function"==typeof i?e.filter(function(e){return!1!==i(e)}):e).length&&t(e)}catch(e){}},W(this)]),this.eventPipeline=O([R(this,10),(o=this,function(e){o.sendPipeline([function(e,t){var n=e.map(function(e){return{name:e.name,ext1:e.ext1||o.config.ext1||"",ext2:e.ext2||o.config.ext2||"",ext3:e.ext3||o.config.ext3||""}});t({url:o.config.eventUrl+"?payload="+encodeURIComponent(JSON.stringify(n)),type:x.EVENT,log:e})}],x.EVENT)(e)})]),this.customTimePipeline=O([R(this,10),(i=this,function(e){return i.sendPipeline([function(e,t){t({url:i.config.customTimeUrl+"?payload="+encodeURIComponent(JSON.stringify({custom:e})),type:x.CUSTOM,log:e})}],x.CUSTOM)(e)})]),this.timeMap={},this.failRequestCount=0,this.config=(t=this.config,void 0===(e=e.hostUrl)&&(e="https://aegis.qq.com"),t.url=t.url||e+"/collect",t.offlineUrl=t.offlineUrl||e+"/offline",t.whiteListUrl=t.whiteListUrl||e+"/collect/whitelist",t.pvUrl=t.pvUrl||e+"/collect/pv",t.eventUrl=t.eventUrl||e+"/collect/events",t.speedUrl=t.speedUrl||e+"/speed",t.customTimeUrl=t.customTimeUrl||e+"/speed/custom",t.performanceUrl=t.performanceUrl||e+"/speed/performance",t.performanceUrlForHippy=t.performanceUrlForHippy||e+"/speed/hippyPerformance",t.webVitalsUrl=t.webVitalsUrl||e+"/speed/webvitals",t.setDataReportUrl=t.SetDataReportUrl||e+"/speed/miniProgramData",t),I.instances.push(this)}return _.use(z),_.use(Y),_.use(Q),_.use(U),_});
